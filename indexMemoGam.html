<!DOCTYPE html>
<html lang="es-es">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">   
        <link rel="stylesheet" type="text/css" href="EstiloMemoGame">     
        <title>Juego de Memoria</title>
        <style>
            .card {
                width: 100px;
                height: 150px;
                background-color: #CCC;
                border: 1px solid #000;
                margin: 10px;
                display: inline-block;
                cursor: pointer;
                text-align: center;
                line-height: 150px;
            }
        </style>
        
    </head>
    <body>
        <table id="ranking">
            <tr>
                <th>Nombre</th>
                <th>Puntaje</th>
            </tr>            
        </table>
        <center>
            <input type="text" id="nombreJugador" placeholder="Ingresa tu nombre de jugador">
            <button onclick="guardarNombre()">Guardar nombre</button>
            <button id="jugarBtn" onclick="jugar()">Jugar</button>
            <div id="cronometro">Tiempo restante: </div>
            <div id="tablero"></div>
        </center>    
        
        <script>
            var cartas = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
            var tablero = document.getElementById('tablero');
            var cronometro = document.getElementById('cronometro');
            var juegoHabilitado = false;
            var intervalo;
            var NombreDelJugador = "";
            var cuentaJugadas = 0;
            var cuentaVictorias = 0;
            var cuentaDerrotas = 0;
            var puntaje = 0;
            var datosFromServer = [
            { Player: "Juan", puntaje: 100 },
            { Player: "María", puntaje: 90 },
            { Player: "Max", puntaje: 80 }
        ];
            var datos = [{"game": "MemoryGame", "player": NombreDelJugador, "eventType":"cuentaJugadas", "value": cuentaJugadas},
                        {"game": "MemoryGame", "player": NombreDelJugador, "eventType":"cuentaVictorias", "value": cuentaVictorias},
                        {"game": "MemoryGame", "player": NombreDelJugador, "eventType":"cuentaDerrotas", "value": cuentaDerrotas,},
                        {"game": "MemoryGame", "player": NombreDelJugador, "eventType":"Puntaje", "value": puntaje}] 
        
            function guardarDatos() {
                localStorage.setItem('datos', JSON.stringify(datos));
            }
        
            function cargarDatos() {
                const datosGuardados = localStorage.getItem('datos');
                if (datosGuardados) {
                    datos = JSON.parse(datosGuardados);
                } else {
                    datos = [
                        { Player: "Jugador1", cuentaJugadas: 0, cuentaVictorias: 0, cuentaDerrotas: 0, puntaje: 0 },
                        { Player: "Jugador2", cuentaJugadas: 0, cuentaVictorias: 0, cuentaDerrotas: 0, puntaje: 0 },
                        { Player: "Jugador3", cuentaJugadas: 0, cuentaVictorias: 0, cuentaDerrotas: 0, puntaje: 0 }
                    ];
                }
            }
            // Crea una nueva conexión WebSocket
            const socket = new WebSocket("wss://socketsbay.com/wss/v2/1/demo/");

            // Escucha por mensajes del servidor WebSocket
            socket.addEventListener("message", function (event) {
            const rankingActualizado = JSON.parse(event.data);
            actualizarRanking(rankingActualizado);
            });
        
            function actualizarRanking(datos) {
                const tabla = document.getElementById("ranking");
                const cuerpoTabla = tabla.getElementsByTagName("tbody")[0];
                cuerpoTabla.innerHTML = ""; // Limpiar tabla

                    datos.forEach((jugador, index) => {
                    const fila = cuerpoTabla.insertRow();
                    const celdaNombre = fila.insertCell(0);
                    const celdaPuntaje = fila.insertCell(1);
                    celdaNombre.textContent = jugador.Player;
                    celdaPuntaje.textContent = jugador.puntaje;
                });
            }
        
            function guardarNombre() {
                const nombre = document.getElementById("nombreJugador").value;
                localStorage.setItem('nombreJugador', nombre);   
                NombreDelJugador = nombre; 
                for (var i = 0; i < datos.length; i++) {
                        if (datos[i].eventType === "player") {
                        datos[i].value = NombreDelJugador;
                        break;
                    }
                }
                location.reload();
            }
        
            document.addEventListener("DOMContentLoaded", function() {
                const nombreGuardado = localStorage.getItem("nombreJugador");
                if (nombreGuardado) {
                    document.getElementById("nombreJugador").value = nombreGuardado;
                }
            });
        
            // Función para iniciar el juego
            function jugar() {
                // Habilitar el juego
                juegoHabilitado = true;
                document.getElementById('jugarBtn').disabled = true;
                // Incrementar el contador en el almacenamiento local
                cuentaJugadas = parseInt(localStorage.getItem('cuentaJugadas')) || 0;
                cuentaJugadas++;
                puntaje = parseInt(localStorage.getItem('puntaje')) || 0;                
                puntaje = puntaje + (cuentaJugadas + cuentaVictorias) - cuentaDerrotas;
                localStorage.setItem('puntaje', puntaje)
                localStorage.setItem('contadorJugadas', cuentaJugadas);              
                // Actualizar el valor de "cuentaJugadas" en el arreglo de datos
                for (var i = 0; i < datos.length; i++) {
                    if (datos[i].eventType === "cuentaJugadas") {
                    datos[i].value = cuentaJugadas;
                    break; // Termina el bucle una vez que se actualiza el valor
                    }
                }
                // Actualizar el valor de "puntaje" en el arreglo de datos
                for (var i = 0; i < datos.length; i++) {
                    if (datos[i].eventType === "Puntaje") {
                    datos[i].value = puntaje;
                    break; // Termina el bucle una vez que se actualiza el valor
                    }
                }
                // Mostrar el contador en un mensaje de alerta
                console.log("Jugaste: " + cuentaJugadas + " veces y tu Puntaje es:" + puntaje);
                // Barajar las cartas
                cartas = cartas.concat(cartas).sort(function() { return 0.5 - Math.random() });        
                // Mostrar las cartas en el tablero
                for (var i = 0; i < cartas.length; i++) {
                    var carta = document.createElement('div');
                    carta.className = 'card';
                    carta.dataset.valor = cartas[i];
                    carta.dataset.estado = 'cerrado';
                    carta.innerHTML = '?';
                    carta.onclick = function() { mostrarCarta(this); };
                    tablero.appendChild(carta);
                }
                // Iniciar el cronómetro (180 segundos = 3 minutos)
                var segundosRestantes = 10;
                intervalo = setInterval(function() {
                    cronometro.textContent = 'Tiempo restante: ' + segundosRestantes + ' segundos';
                    segundosRestantes--;
                    if (segundosRestantes < 0) {
                        clearInterval(intervalo);
                        if (juegoHabilitado) {
                            juegoHabilitado = false;
                            // Incrementar el contador en el almacenamiento local
                            cuentaDerrotas = parseInt(localStorage.getItem('cuentaDerrotas')) || 0;
                            cuentaDerrotas++;
                            puntaje = parseInt(localStorage.getItem('puntaje')) || 0;                
                            puntaje = puntaje + (cuentaJugadas + cuentaVictorias) - cuentaDerrotas;
                            localStorage.setItem('puntaje', puntaje)
                            localStorage.setItem('cuentaDerrotas', cuentaDerrotas);   
                            // Actualizar el valor de "cuentaJugadas" en el arreglo de datos
                            for (var i = 0; i < datos.length; i++) {
                                if (datos[i].eventType === "cuentaDerrotas") {
                                datos[i].value = cuentaDerrotas;
                                break; // Termina el bucle una vez que se actualiza el valor
                                }
                            }
                            // Actualizar el valor de "puntaje" en el arreglo de datos
                            for (var i = 0; i < datos.length; i++) {
                                if (datos[i].eventType === "Puntaje") {
                                datos[i].value = puntaje;
                                break; // Termina el bucle una vez que se actualiza el valor
                                }
                            }                 
                            // Mostrar el contador en un mensaje de alerta                    
                            console.log("Perdiste: " + cuentaDerrotas + " veces y tu Puntaje es: " + puntaje);
                        }   
                    }
                }, 1000);
        
                // Actualizar el ranking
                datos.forEach((jugador, index) => {
                    if (jugador.Player === NombreDelJugador) {
                        jugador.puntaje = puntaje;
                        jugador.cuentaJugadas = cuentaJugadas;
                        jugador.cuentaVictorias = cuentaVictorias;
                        jugador.cuentaDerrotas = cuentaDerrotas;
                    }
                });
                actualizarRanking(datosFromServer);
                guardarDatos();
            }
        
            // Función para mostrar una carta
            function mostrarCarta(carta) {
                if (!juegoHabilitado || carta.dataset.estado === 'abierta') return;            
                carta.innerHTML = carta.dataset.valor;
                carta.dataset.estado = 'abierta';            
                // Verificar si todas las cartas están abiertas
                var cartasAbiertas = document.querySelectorAll('.card[data-estado="abierta"]');
                if (cartasAbiertas.length === 16) {
                    clearInterval(intervalo);
                    juegoHabilitado = false;
                    // Incrementar el contador en el almacenamiento local
                    cuentaVictorias = parseInt(localStorage.getItem('cuentaVictorias')) || 0;
                    cuentaVictorias++;
                    puntaje = parseInt(localStorage.getItem('puntaje')) || 0;                
                    puntaje = puntaje + (cuentaJugadas + cuentaVictorias) - cuentaDerrotas;
                    localStorage.setItem('puntaje', puntaje)
                    localStorage.setItem('cuentaVictorias', cuentaVictorias);
                    // Actualizar el valor de "cuentaJugadas" en el arreglo de datos
                for (var i = 0; i < datos.length; i++) {
                    if (datos[i].eventType === "cuentaVictorias") {
                    datos[i].value = cuentaVictorias;
                    break; // Termina el bucle una vez que se actualiza el valor
                    }
                }
                // Actualizar el valor de "puntaje" en el arreglo de datos
                for (var i = 0; i < datos.length; i++) {
                    if (datos[i].eventType === "Puntaje") {
                    datos[i].value = puntaje;
                    break; // Termina el bucle una vez que se actualiza el valor
                    }
                }
                    // Mostrar el contador en un mensaje de alerta
                    console.log("Ganaste: " + cuentaVictorias + " veces y tu Puntaje es: " + puntaje);
                }
            }
        
            cargarDatos();
            actualizarRanking(datosFromServer);
        </script>
    </body>
</html> 